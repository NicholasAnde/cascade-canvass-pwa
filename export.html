<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cascade Canvass — Export</title>
  <meta name="theme-color" content="#111111"/>
  <link rel="stylesheet" href="assets/style.css"/>
</head>
<body>
  <main style="padding:1rem">
    <section class="card">
      <h2>Export Data</h2>
      <p>Exports merge of Visits and Leads from this device (local cache).</p>
      <div class="btn-row">
        <button class="primary" id="btn">Download merged.csv</button>
      </div>
      <p class="mono" id="meta"></p>
    </section>
  </main>
  <script>
    function esc(v){ return \"\" + String(v??'').replace(/\\"/g,'\\"') + \"\"; }
    function toCSV(rows){
      if(!rows.length) return '';
      const keys = Object.keys(rows[0]);
      return [keys.map(esc).join(','), ...rows.map(r=>keys.map(k=>esc(r[k])).join(','))].join('\n');
    }
    function download(name, text){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type:'text/csv'}));
      a.download = name; a.click();
    }
    const visits = JSON.parse(localStorage.getItem('visitsLog')||'[]');
    const leads  = JSON.parse(localStorage.getItem('leadsLog')||'[]');
    const merged = [...visits, ...leads].sort((a,b)=> String(a.time||a.date).localeCompare(String(b.time||b.date)));
    document.getElementById('meta').textContent = `Visits: ${visits.length} • Leads: ${leads.length} • Total: ${merged.length}`;
    document.getElementById('btn').onclick = ()=> download('merged.csv', toCSV(merged));
  </script>
</body>
</html>
