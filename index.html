<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Cascade Canvass â€” PWA</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <meta name="theme-color" content="#111111"/>
  <link rel="icon" href="icons/favicon.png"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="assets/style.css"/>

  <style>
    .addr-row{display:grid;grid-template-columns:1fr auto;gap:.5rem;align-items:center}
    .iconbtn.locate{border:1px solid #2a2a2a;background:#0b0b0b;padding:.55rem .6rem;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;transition:transform .08s ease}
.iconbtn.locate span{font-weight:600;letter-spacing:.2px}
    .iconbtn.locate:active{transform:scale(0.98)}
    .iconbtn.locate[disabled]{opacity:.6;cursor:not-allowed}
    #nd-locate-status{display:block;margin-top:.25rem;min-height:1.25rem}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>


  <style>
    .addr-row{display:grid;grid-template-columns:1fr;gap:.5rem;align-items:center}
    .iconbtn.locate{border:1px solid #2a2a2a;background:#0b0b0b;padding:.7rem .9rem;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;transition:transform .08s ease}
    .iconbtn.locate:active{transform:scale(0.98)}
    .iconbtn.locate[disabled]{opacity:.6;cursor:not-allowed}
    .iconbtn.locate svg{margin-right:.5rem;vertical-align:middle}
    #nd-locate-status{display:block;margin-top:.25rem;min-height:1.25rem}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>

</head>
<body>
  <header class="topbar">
    <button class="iconbtn tree" onclick="toggleDrawer()" aria-label="Menu"><span class="tree-emoji">ðŸŒ²</span></button>
    <h1>Cascade Canvass</h1>
    <button class="iconbtn" onclick="if(window.refreshGeoList) refreshGeoList()" aria-label="Reload nearby">âŸ³</button>
  </header>
<aside id="drawer" class="drawer" aria-hidden="true">
    <header>Menu</header>
    <nav class="nav">
      <a href="#" onclick="nav('dashboard')">Home</a>
      <a href="#" onclick="nav('knock')">Next Door</a>
      <a href="#" onclick="nav('lead')">New Lead</a>
      <a href="#" onclick="nav('tracker')">Lead Tracker</a>
      <a href="#" onclick="nav('maptoday')">Map</a>
      <a href="#" onclick="nav('scripts')">Scripts</a>
      <a href="#" onclick="nav('settings')">Settings</a>
    </nav>
  </aside>

  <main id="view"></main>

  <footer class="foot"><small>Mobile PWA</small></footer>

  <div id="toast-root" aria-live="polite" aria-atomic="true"></div>
  <div id="err" class="err" style="display:none"></div>

  
  



  


  


  <script>
  (function patchNavForNextDoor(){
    const origGo = window.go;
    window.go = function(tab){
      const result = origGo ? origGo.apply(this, arguments) : undefined;
      if(tab==='knock'){
        setTimeout(()=>{
          try{
            const card = document.querySelector('#view');
            if(!card) return;
            let addressInput = Array.from(card.querySelectorAll('input')).find(el=>{
              const idn=(el.id||'').toLowerCase(), nm=(el.name||'').toLowerCase(), ph=(el.placeholder||'').toLowerCase();
              const lbl=(el.getAttribute('aria-label')||'').toLowerCase();
              return idn.includes('address')||nm.includes('address')||ph.includes('address')||lbl.includes('address');
            });
            if(!addressInput) return;
            if(card.querySelector('#nd-locate')) return; // already present

            const wrap = document.createElement('div');
            wrap.className='addr-row';
            const btn = document.createElement('button');
            btn.id='nd-locate'; btn.type='button'; btn.className='iconbtn locate';
            btn.setAttribute('aria-label','Match Address'); btn.title='Match Address';
            btn.innerHTML='<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M12 2l3 7 7 3-7 3-3 7-3-7-7-3 7-3 3-7z"></path></svg><span>Match Address</span>';
            const note = document.createElement('small'); note.id='nd-locate-status'; note.className='muted'; note.setAttribute('role','status'); note.setAttribute('aria-live','polite');
            wrap.appendChild(btn);
            addressInput.insertAdjacentElement('afterend', wrap);
            wrap.insertAdjacentElement('afterend', note);

            function setStatus(msg){ note.textContent = msg||''; }
            function setBusy(b){ btn.disabled = !!b; btn.setAttribute('aria-busy', b ? 'true' : 'false'); }

            btn.addEventListener('click', ()=>{
              if(!('geolocation' in navigator)){ setStatus('Location not supported.'); return; }
              setBusy(true); setStatus('Getting locationâ€¦');
              navigator.geolocation.getCurrentPosition(pos=>{
                const { latitude: lat, longitude: lon, accuracy } = pos.coords;
                addressInput.value = lat.toFixed(6)+', '+lon.toFixed(6);
                addressInput.dispatchEvent(new Event('input',{bubbles:true}));
                addressInput.dispatchEvent(new Event('change',{bubbles:true}));
                setStatus('Coordinates filled (Â±'+Math.round(accuracy)+'m).');
                setBusy(false);
              }, err=>{
                const map={1:'Permission denied.',2:'Location unavailable.',3:'Timed out.'};
                setStatus(map[err.code]||'Location error.');
                setBusy(false);
              },{enableHighAccuracy:true,timeout:15000,maximumAge:0});
            });

            // Remove "No Answer" and "Next Closet" buttons
            Array.from(card.querySelectorAll('button')).forEach(b=>{
              const t=(b.textContent||'').trim().toLowerCase();
              if(t==='no answer'||t==='next closet'||t==='next closest'){ b.remove(); }
            });

          }catch(e){ console.error('NextDoor patch error', e); }
        }, 500); // wait half a sec for DOM
      }
      return result;
    };
  })();
  </script>


  <script>
  (function nextDoorOnNav(){
    function qsa(root, sel){ return Array.from((root||document).querySelectorAll(sel)); }
    function isNextDoorCard(node){
      if(!node) return false;
      const header = (node.querySelector && Array.from(node.querySelectorAll('h1,h2,h3')).find(h => (h.textContent||'').trim().toLowerCase()==='next door')) || null;
      return !!header;
    }
    function findNextDoorCard(){
      const cards = qsa(document, '.card');
      return cards.find(isNextDoorCard) || null;
    }
    function findAddressInput(card){
      return qsa(card, 'input').find(el=>{
        const idn=(el.id||'').toLowerCase(), nm=(el.name||'').toLowerCase(), ph=(el.placeholder||'').toLowerCase();
        const lbl=(el.getAttribute('aria-label')||'').toLowerCase();
        return idn.includes('address')||nm.includes('address')||ph.includes('address')||lbl.includes('address');
      });
    }
    function injectMatchButton(card){
      if(!card || card.querySelector('#nd-locate')) return;
      const input = findAddressInput(card);
      if(!input) return;
      const wrap = document.createElement('div');
      wrap.className='addr-row';
      const btn = document.createElement('button');
      btn.id='nd-locate'; btn.type='button'; btn.className='iconbtn locate';
      btn.setAttribute('aria-label','Match Address'); btn.title='Match Address';
      btn.innerHTML='<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M12 2l3 7 7 3-7 3-3 7-3-7-7-3 7-3 3-7z"></path></svg><span>Match Address</span>';
      const note = document.createElement('small'); note.id='nd-locate-status'; note.className='muted'; note.setAttribute('role','status'); note.setAttribute('aria-live','polite');
      wrap.appendChild(btn);
      input.insertAdjacentElement('afterend', wrap);
      wrap.insertAdjacentElement('afterend', note);

      function setStatus(msg){ note.textContent = msg||''; }
      function setBusy(b){ btn.disabled = !!b; btn.setAttribute('aria-busy', b ? 'true' : 'false'); }

      btn.addEventListener('click', ()=>{
        if(!('geolocation' in navigator)){ setStatus('Location not supported.'); return; }
        setBusy(true); setStatus('Getting locationâ€¦');
        navigator.geolocation.getCurrentPosition(pos=>{
          const { latitude: lat, longitude: lon, accuracy } = pos.coords;
          input.value = lat.toFixed(6) + ', ' + lon.toFixed(6);
          input.dispatchEvent(new Event('input', {bubbles:true}));
          input.dispatchEvent(new Event('change', {bubbles:true}));
          setStatus('Coordinates filled (Â±'+Math.round(accuracy)+'m).');
          setBusy(false);
        }, err=>{
          const map={1:'Permission denied.',2:'Location unavailable.',3:'Timed out.'};
          setStatus(map[err.code] || 'Location error.');
          setBusy(false);
        }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
      });
    }

    function enhanceAfterRender(){
      // Try multiple ticks to wait for view render
      let tries = 0;
      const maxTries = 20;
      (function tick(){
        const card = findNextDoorCard();
        if(card){ injectMatchButton(card); return; }
        if(++tries < maxTries){ requestAnimationFrame(tick); }
      })();
    }

    // Wrap window.go if present
    const origGo = window.go;
    if(typeof origGo === 'function'){
      window.go = function(tab){
        const ret = origGo.apply(this, arguments);
        const name = (''+tab).toLowerCase();
        if(name.includes('knock') || name.includes('next')){
          setTimeout(enhanceAfterRender, 0);
        }
        return ret;
      }
    }

    // Fallback: listen to hash changes or manual "Next Door" navigation
    window.addEventListener('hashchange', ()=>{
      const h = (location.hash||'').toLowerCase();
      if(h.includes('knock') || h.includes('next')) setTimeout(enhanceAfterRender, 0);
    });

    // Also add a gentle observer for short time after load (in case first view is Next Door)
    document.addEventListener('DOMContentLoaded', ()=>{
      let observed = 0;
      const mo = new MutationObserver((muts)=>{
        observed += muts.length;
        const card = findNextDoorCard();
        if(card){ injectMatchButton(card); mo.disconnect(); }
        if(observed > 50){ mo.disconnect(); } // stop after some churn to avoid overhead
      });
      const target = document.body;
      mo.observe(target, { childList:true, subtree:true });
      // Stop the observer after 5s regardless
      setTimeout(()=> mo.disconnect(), 5000);
    });
  })();
  </script>

</body>
</html>
